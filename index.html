<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
      body { background: #020617; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: system-ui, sans-serif;}
      h3 { text-align: center; margin: 6px 0 10px; }
      input { width: 100%; background: #020617; color: white; border: 1px solid #334155; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
      button { width: 100%; background: linear-gradient(135deg,#38bdf8,#6366f1); color: black; border: none; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 8px;}
      button.danger { background: linear-gradient(135deg,#fb7185,#ef4444); }
      
      .error { color: #f87171; text-align: center; font-size: 13px; }
      .info { color: #22c55e; text-align: center; font-size: 12px; margin-bottom: 6px; }
      .message { max-width: 75%; padding: 8px 10px; margin: 6px 0; border-radius: 12px; line-height: 1.3; word-wrap: break-word; }
      .message.me { margin-left: auto; background: #2563eb; color: white; border-bottom-right-radius: 4px; }
      .message.other { margin-right: auto; background: #1e293b; }
      .message.shout { background: #dc2626; color: white; margin: 10px auto; text-align: center; font-weight: bold; }
      .user { font-size: 11px; opacity: 0.7; font-weight: bold; }
      .time { font-size: 10px; opacity: 0.5; text-align: right; }
      .date-divider { text-align: center; font-size: 12px; color: #facc15; margin: 10px 0; font-weight: bold; }
      
      #chat-widget { width: 420px; max-width: 95vw; height: 600px; background: #0f172a; color: #e5e7eb; border-radius: 14px; padding: 14px; display: flex; flex-direction: column;}
      #messages { flex: 1; max-height: 400px; background: #020617; border-radius: 10px; padding: 8px; overflow-y: auto; margin-bottom: 10px; font-size: 13px; }
    </style>
  </head>
  <body>
    <div id="chat-widget">
      <div id="loginDiv">
        <h3>üîê Login</h3>
        <input id="usernameInput" placeholder="Username">
        <input id="passwordInput" type="password" placeholder="Password">
        <button id="loginBtn">Login</button>
        <p id="loginError" class="error"></p>
      </div>

      <div id="chatDiv" style="display:none; flex-direction:column;">
        <h3>Group Chat</h3>
        <div id="messages"></div>
        <input id="messageInput" placeholder="Type a message or shout with /shout">
        <p id="loginInfo" class="info"></p  >
        <button id="mc">üéÆ Launch   Minecraft</button >
        <button id="signOutBtn" class="danger ">Sign Out</button>
      </div>
    </div>

    <script>
      firebase.initializeApp({apiKey:"AIzaSyD9gD2PgytC59LjpsOc75y7LlZswGOWkQw", databaseURL:"https://chat-app-fa784-default-rtdb.asia-southeast1.firebasedatabase.app"});

      const db = firebase.database();

      const loginDiv = document.getElementById("loginDiv");
      const chatDiv = document.getElementById("chatDiv");
      const messagesDiv = document.getElementById("messages");
      const input = document.getElementById("messageInput");
      const loginError = document.getElementById("loginError");
      const loginInfo = document.getElementById("loginInfo");
      const usernameInput = document.getElementById("usernameInput");
      const passwordInput = document.getElementById("passwordInput");
      const loginBtn = document.getElementById("loginBtn");
      const signOutBtn = document.getElementById("signOutBtn");
      const mc = document.getElementById("mc");

      let currentUser = "";
      let canSend = true;
      let shoutCooldown = false;
      let lastDate = "";
      let mutedUsers = {};

      // --- DATE/TIME FORMAT ---
      function formatDate(d){
          const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
          return `${months[d.getMonth()]} ${d.getDate()} ${d.getFullYear()}`;
      }
      function formatTime(d){ return d.toTimeString().slice(0,5); }

      // --- LOGIN ---
      loginBtn.onclick = async () => {
          loginError.textContent = "";
          const u = usernameInput.value.trim();
          const p = passwordInput.value.trim();
          if(!u || !p){
              loginError.textContent = "Username & password required";
              return;
          }
          try {
              const snap = await db.ref("users/"+u).get();
              if(!snap.exists() || snap.val().password !== p){
                  loginError.textContent = "Invalid login";
                  return;
              }
              currentUser = u;
              loginDiv.style.display = "none";
              chatDiv.style.display = "flex";
              loginInfo.textContent = "Logged in as " + u;
              attachMessages();
          } catch(err){
              console.error(err);
              loginError.textContent = "Database error";
          }
      };

      // --- CHAT ---
      function attachMessages(){
          messagesDiv.innerHTML = "";
          db.ref("chat").off();
          lastDate = "";
          db.ref("chat").on("child_added", snap => {
              const d = snap.val();
              if(mutedUsers[d.user]) return;
              const date = new Date(d.timestamp);
              const dateStr = formatDate(date);
              if(dateStr !== lastDate){
                  lastDate = dateStr;
                  const divider = document.createElement("div");
                  divider.className = "date-divider";
                  divider.textContent = `-- ${dateStr} --`;
                  messagesDiv.appendChild(divider);
              }
              const msg = document.createElement("div");
              msg.classList.add("message");
              if(d.shout){
                  msg.classList.add("shout");
                  msg.textContent = `${d.user}: ${d.text}`;
              } else {
                  msg.classList.add(d.user === currentUser ? "me" : "other");
                  const u = document.createElement("div"); u.className="user"; u.textContent=d.user;
                  const b = document.createElement("div"); b.textContent=d.text;
                  const t = document.createElement("div"); t.className="time"; t.textContent=formatTime(date);
                  msg.append(u,b,t);
              }
              messagesDiv.appendChild(msg);
              messagesDiv.scrollTop = messagesDiv.scrollHeight;
          });
      }

      // --- SEND MESSAGE ---
      input.addEventListener("keydown", async e => {
          if(e.key!=="Enter" || !canSend) return;
          const text = input.value.trim();
          if(!text) return;

          if(text.startsWith("/")){
              const parts = text.slice(1).split(" ");
              const cmd = parts.shift().toLowerCase();
          
              // --- ADMIN COMMANDS ---
              if(currentUser==="Admin"){
                  if(cmd==="clear"){ await db.ref("chat").remove(); messagesDiv.innerHTML=""; input.value=""; return; }
                  if(cmd==="mute"){
                      if(parts.length<3){ loginInfo.textContent="Invalid format"; input.value=""; return; }
                      const target=parts[0], minutes=parts[1], msgText=parts.slice(2).join(" ");
                      if(isNaN(minutes) || minutes<=0){ loginInfo.textContent="Invalid format"; input.value=""; return; }
                      const snap=await db.ref("users/"+target).get();
                      if(!snap.exists()){ loginInfo.textContent="Invalid user"; input.value=""; return; }
                      mutedUsers[target]=true;
                      db.ref("chat").push({ user:"System", text:`Muted ${target} for ${minutes} minutes: ${msgText}`, shout:true, timestamp:Date.now() });
                      input.value=""; return;
                  }
                  if(cmd==="unmute"){
                      const target=parts[0];
                      if(!target){ loginInfo.textContent="Invalid format"; input.value=""; return; }
                      delete mutedUsers[target];
                      db.ref("chat").push({ user:"System", text:`Unmuted ${target}`, shout:true, timestamp:Date.now() });
                      input.value=""; return;
                  }
              }
            
              if(cmd==="shout"){ 
                  if(shoutCooldown) return;
                  db.ref("chat").push({ user:currentUser, text:parts.join(" "), shout:true, timestamp:Date.now() });
                  shoutCooldown=true; setTimeout(()=>shoutCooldown=false,15000);
                  input.value=""; return;
              }
            
              loginInfo.textContent="Invalid command"; input.value=""; return;
          }
        
          db.ref("chat").push({ user:currentUser, text, shout:false, timestamp:Date.now() });
          input.value=""; canSend=false; setTimeout(()=>canSend=true,800);
      });

      // --- SIGN OUT ---
      signOutBtn.onclick = () => {
          db.ref("chat").off();
          currentUser="";
          chatDiv.style.display="none";
          loginDiv.style.display="block";
      };

      // --- LAUNCH MINECRAFT ---
      mc.onclick = async () => {
          const w = window.open();
          if(!w) return;
          const html = await fetch("https://cdn.jsdelivr.net/gh/PlanetDogeCodes/Eagletcraft-1.12@main/source%20file/egc1-12.xml").then(r=>r.text());
          w.document.write(html);
          w.document.close();
      };
    </script>
  </body>
</html>
